# Results
```{r}
library(readr)
library(dbplyr)
library(tidyverse)
library(ggalluvial)
```

```{r}
# Get a list of files that match a certain pattern
files <- list.files(path="player-moves", pattern="*csv", full.names=TRUE, recursive=FALSE)

# Create an empty data frame to store the combined data
all_games <- read.csv("player-moves/all-games.csv")
```

```{r}

colnames(all_games) <- c("game_id", "white_name","status", "white_elo", "black_name", "black_elo", "result", "move_number", "move")

```
First, lets take a look at the number of wins, losses and draws with the white pieces in the dataset.
```{r}
ratings <- all_games
ratings <- subset(ratings, move_number == 1)

# Get the number of rows in the data frame
num_rows <- nrow(ratings)

# Create a vector of ones with the same number of rows as the data frame
ones <- rep(1, num_rows)

# Add the vector of ones to the data frame as a new column

ratings <- ratings %>% 
  mutate(result = fct_relevel(result, "0-1", "1/2-1/2", "1-0"))

ratings <- ratings %>% 
  mutate(result = fct_relevel(result, "0-1", "1/2-1/2", "1-0"))

ggplot(data = ratings) +
  geom_bar(aes(x=result)) +
  coord_flip() +
  xlab("Results") +
  ylab("Number of Games") +
  ggtitle("Number of Wins, Losses and Draws in the Dataset")
```
Because we are looking at games from the best players in the world, it isn't surprising that there are significantly more wins for these top level players than losses in the database. This graph does show that even the best players are fallible, with over 5000 combined losses. 

To gain more insight on the wins and losses of individual players, let's graph the number of games each player played and split the bars up by wins, draws and losses.

```{r}
ggplot(data = ratings) +
  geom_bar(aes(x=fct_rev(fct_infreq(white_name)),fill=result)) +
  coord_flip() +
  xlab("Player Name") +
  ylab("Number of Games") +
  ggtitle("Number of Wins, Losses and Draws by Player")
  #theme(axis.text.x = element_text(angle = 75))
```

Now lets look at the top players rating verses their opponents rating.


```{r}
real_ratings <-ratings %>% filter(white_elo != '?')
real_ratings <-real_ratings %>% filter(black_elo != '?')
real_ratings <-real_ratings %>% filter(white_elo > 100)
real_ratings <-real_ratings %>% filter(black_elo > 100)
real_ratings <- na.omit(real_ratings)
real_ratings$black_elo <- as.numeric(real_ratings$black_elo)
real_ratings$white_elo <- as.numeric(real_ratings$white_elo)
ggplot(data = real_ratings) +
  geom_point(aes(x=white_elo, y=black_elo), alpha=.05) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  xlab("White Rating") +
  ylab("Black Rating") +
  ggtitle("Top Grand Masters' Ratings (white) vs Oponent Ratings (black)")
```

Taking a look at the above graph, we see that most of the games were played between players of ratings between 2000 and 3000. Modern super grand masters have ratings between 2700 and 2900 offline, and can have ratings of above 3000 in Online games. With this information and the graph, it is clear that there are some games being played in the online formats in the database. Inspection into the data before it was cleaned can confirm this. While it looks like there are some games in the > 3000 range, most are not. This suggests that nearly all of the games recorded in the database were played offline.

Lets dive a little deeper and look at the rating of the current wold number one player Magnus Carlsen vs his opponent's ratings. We will also zoom in to take a closer look at the data.

```{r}
Carlsen_ratings <-real_ratings %>% filter(white_name == "Magnus Carlsen")
ggplot(data = Carlsen_ratings) +
  geom_point(aes(x=white_elo, y=black_elo), alpha=.05) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  xlab("White Rating") +
  ylab("Black Rating") +
  ggtitle("Magnus Carlsen's Ratings (white) vs Oponent Ratings (black)")
```

There are a few important pieces of information that can be obtained by looking at this graph. First, it shows games where Carlsen was rated below 2100. These were likely when he was very young. Because of this, we know that games in the data base do not all represent the top grand masters in their prime. It also looks like there are some interesting patterns in the data, where white elo is closely grouped together in a line. Let's dig deeper into this.

```{r}
ggplot(data = Carlsen_ratings) +
  geom_histogram(aes(white_elo), binwidth = 5) +
  xlab("White Rating") +
  ylab("Number of Games") +
  ggtitle("Magnus Carlsen's Ratings")
```
Upon further examination, it looks like assumption that there were lots of games with the same rating is correct. One reason this might be the case is because FIDE only updates a player's ELO rating once a month. This means if a player plays in a few tournaments over the course of a month, they could play tens of games, all with the same rating. It is also possible that a player arrived at the same rating in different months.

Lets look at how often some of the most popular openings win.

```{r}
move_df <- all_games
first_moves_df <- move_df |> filter(move_number==1)
# Group the data by the first move and count the number of occurrences of each move
first_moves <- first_moves_df %>%
  group_by(move) %>%
  summarize(n = n()) %>%
  arrange(desc(n))

# Select the top four most common first moves
common_moves <- first_moves[1:10, ]

# Filter the original data frame to only include games with the top four first moves
filtered_df <- first_moves_df %>%
  filter(move %in% common_moves$move)

# move_win_df <- filtered_df |> group_by(move, result) |> summarize(count=n())

ggplot(data = filtered_df) +
  geom_bar(aes(x=fct_rev(fct_infreq(move)),fill=result)) +
  coord_flip() +
  xlab("Opening Moves") +
  ylab("Number of Games") +
  ggtitle("Number of Wins, Losses and Draws by First Move")
```
Above, we see the graph of most common first moves from the white and the black players. When documenting chess moves for knights, rooks, bishops, kings, or queens, a N, R, B, K, and Q will be used respectively. These letters are capitalized. If no capitalized letter is present at the start of the move, this means that a pawn is moved forward. The last two characters in most cases correspond to the square that the piece will move to. If a piece is captured during the move, an x is placed before the square that the piece is captured on. There are other special cases for chess documentation, none of which are present in the further analysis.

After one move from each player, the most common board position from the best of all time has the pawn that starts on d2 moved to d4 and the knight that starts on g8 moved to f6.

In general in chess, the two most common moves from white are e4 and d4. This can clearly be seen from the graph above. Seven of the ten most common opening moves start with one of these two initial thrusts forward into the center.
```{r}
# Select the top four most common first moves
common_moves <- first_moves[1:4, ]

# Filter the original data frame to only include games with the top four first moves
filtered_df <- all_games %>%
  filter(move %in% common_moves$move & move_number == 1)

common_games <- all_games %>%
  filter(game_id %in% filtered_df$game_id & move_number == 1)

#common_games <- common_games %>% pivot_wider(names_from = move_number, values_from = move) 

CHAMPS <- c('Magnus Carlsen', 'Viswanathan Anand', 'Vladimir Kramnik',
            'Garry Kasparov', 'Anatoly Karpov', 'Bobby Fischer',
          'Boris Spassky', 'Tigran Petrosian', 'Mikhail Tal', 'Vasily Smyslov',
          'Mikhail Botvinnik', 'Max Euwe',
          'Alexander Alekhine', 'Jose Raul Capablanca',
          'Emanuel Lasker', 'Wilhelm Steinitz')


games_by_move <- common_games |> 
  group_by(move, result, white_name) |> summarize(count=n()) |> arrange(count)

games_by_move <- games_by_move %>% filter(white_name %in% CHAMPS )

#games_by_move <- games_by_move %>% mutate(level = factor(white_name, levels = CHAMPS))



ggplot(data=games_by_move,
       aes(axis2=move, axis1=white_name, axis3=result, y=count)) +
  geom_alluvium(aes(fill=result))+
  geom_stratum() +
  geom_text(stat = "stratum",
            aes(label = after_stat(stratum))) +
  ggtitle("Common Moves and Results by World Champion")+
  theme_void()
```

This graph shows the most common moves and their results by past world champion. Let's dive into the moves of a couple of players. Former world champion Viswanathan Anand clearly favored playing e4 over d4. We can see from the alluvial diagram that the amount of games that he played against the Sicilian defense (e4 c5) and in double kings pawn games (e4 e5) greatly outnumbers the number of games he played starting with d4. Bobby Fisher had a similar preference for e4. Fisher has a famous quote saying that e4 is "best by test." On the other hand, players like Anatoly Karpov played d4 more than e4. A lot of opening preparation comes down to personal preference.

```{r}
player <- c('Wilhelm Steinitz', 'Emanuel Lasker', 'Jose Raul Capablanca','Alexander Alekhine','Max Euwe','Alexander Alekhine','Mikhail Botvinnik','Vasily Smyslov','Mikhail Botvinnik','Mikhail Tal','Mikhail Botvinnik','Tigran Petrosian','Boris Spassky','Bobby Fischer','Anatoly Karpov','Garry Kasparov','Vladimir Kramnik', 'Viswanathan Anand', 'Magnus Carlsen')

end_year <- c(1894, 1921, 1927, 1935, 1937, 1948, 1957, 1958, 1960, 1961, 1963, 1969, 1972, 1975, 1985, 2000, 2007, 2013, 2021)

wc_df <- data.frame(player, end_year)
colnames(wc_df) <- c("white_name", "year")
wc_df <- merge(x = wc_df, y = all_games |> filter(move %in% common_moves$move & move_number == 1), by = "white_name")
wc_df <- wc_df %>%
  group_by(white_name, year, move) %>%
  summarize(count = n())

moves <- factor(wc_df$move)

wrapper <- function(x, ...) 
{
  paste(strwrap(x, ...), collapse = "\n")
}

my_title <- "World Champion Games in Database vs The Year They Stopped being World Champion by Four Most Common Moves"

ggplot(wc_df) +
  geom_line(mapping=aes(x=year,y=count, color=moves)) +
  theme_classic() + 
  xlab("Year") +
  ylab("Number of Games") +
  ggtitle(wrapper(my_title, width = 60))


```
From the graph above, what we can discern is that there has not been much of a change in usage for any of the top four most common moves over time except for e4 c5. All other common openings appear to change randomly, likely with the world champion's preference. E4 c5 has seen an increase in top level play over time.
## Move to move relation
```{r}
move_df |>
  filter(move_number < 4) |>
  pivot_wider(names_from = move_number, values_from = move) |>
  filter(`1` == "d4 Nf6") |>
  mutate(`2` = fct_lump_n(`2` %>% as.factor, n=4)) |>
  mutate(`3` = fct_lump_n(`3` %>% as.factor, n=6)) |>
  group_by(`1`, `2`, `3`, result) |>
  summarize(games=n()) |>
  arrange(desc(games)) |>
    ggplot(aes(axis1=`1`, axis2=`2`, axis3=`3`, axis4=result, y=games)) +
    geom_alluvium(aes(fill=result))+
    geom_stratum() +
    geom_text(stat = "stratum",
              aes(label = after_stat(stratum))) +
    ggtitle("Common Following Moves and Results for the Opening Knight")+
    theme_void()

move_df |>
  filter(move_number < 4) |>
  pivot_wider(names_from = move_number, values_from = move) |>
  filter(`1` == "e4 e5") |>
  mutate(`2` = fct_lump_n(`2` %>% as.factor, n=4)) |>
  mutate(`3` = fct_lump_n(`3` %>% as.factor, n=6)) |>
  group_by(`1`, `2`, `3`, result) |>
  summarize(games=n()) |>
  arrange(desc(games)) |>
  ggplot( aes(axis1=`1`, axis2=`2`, axis3=`3`, axis4=result, y=games)) +
    geom_alluvium(aes(fill=result))+
    geom_stratum() +
    geom_text(stat = "stratum",
              aes(label = after_stat(stratum))) +
    ggtitle("Common Following Moves and Results for (one of) an Opening Pawn")+
    theme_void()
```
Taking a deeper dive into opening moves, lets look at the most board positions after a couple of moves. First, let's consider the opening moves d4 Nf6. In this case, the most common reply is c4 by white. This move pattern indicates that an Indian defense, known for it's sharp tactics and aggression, will be played. The following two most common moves by black set up different variations of the defense. E6 sets up a Nimzo-Indian Defense and g6 sets up a king's Indian defense.

The position after the starting moves e4 e5 results in a battle for control of the center of the board. The move Nf3 attacks the black pawn on e5, and black must respond to the threat. The most common and versatile move is Nc6. This both protects the pawn, and puts pressure on the d4 square, preventing white from striking in the center by playing pawn to d4. After Nc6, Bb5 is a common response from white. This is known as the Ruy Lopez, or the Spanish opening. Here, white is developing their bishop, while also putting pressure on the knight that is now controlling the center of the board.

```{r}
##TODO create a graph for openers -> turns
# For this, need a table of opener + maximum turn
# To create that, need a maximum turn per game id and an opener per game id
id_moves <- move_df |>
  filter(move_number == 1) |>
  select(game_id, move)

id_turns <- move_df |>
  group_by(game_id) |>
  summarize(moves = max(move_number))

total_games = nrow(id_turns)

opener_lengths = list(id_moves, id_turns) |>
  reduce(full_join, by='game_id') |>
  group_by(move) |>
  summarize(average_moves = mean(moves), games = n(), std_deviation = sd(moves)) |>
  filter(games >= total_games / 1000) |>
  arrange(average_moves)

opener_lengths |>
  select('move', 'average_moves', 'std_deviation') |>
  gather(key='type', value='value', average_moves, std_deviation) |>
  ggplot(aes(x=value, y=fct_reorder2(move,type=='average_moves',value,.desc=FALSE), color=type)) +
    geom_point() +
    ylab("") +
    ggtitle("Average move number and deviation per opener") +
    theme_linedraw()
```
Interestingly, some openings lend themselves to longer games. In chess, there is a notion of a positional game versus a tactical game. Positional games involve slowly moving pieces around, looking for slight advantages in position over an opponent. Tactical games involve making sharp threats against the other person's pieces or against the king. Tactical games are more likely to end quickly because pieces are removed quickly during the attacks. The graph above suggests that Nf3 d5 results in a more positional game than moves like e4 c5.
```{r, warning=FALSE}
pieces <- c('K', 'Q', 'R', 'B', 'N')

piece_type <- function(x) {
  char <- substring(x, 1, 1)
  if(char %in% pieces){
    char
  } else if(char == '0') {
    "K R"
  } else {
    "P"
  }
}

move_types <- function(x) {
  parts <- strsplit(x, " ")
  if (length(parts[[1]]) == 2) {
    paste(piece_type(parts[[1]][1]), piece_type(parts[[1]][2]), sep=" ")
  } else {
    piece_type(parts[[1]][1])
  }
}

# The actual max is much higher, but the outliers look pretty ugly at this
# size of a dataset. Probably a better solution, I set them to be invisible and
# bounded the top.
move_df |>
  select('game_id', 'move_number', 'move') |>
  mutate(filt = mapply(function(x) move_types(x), move)) |>
  separate(filt, c("white_move", "black_move")) |>
  drop_na(black_move) |>
  pivot_longer(cols = !c("game_id", "move_number", "move"), values_to = "piece") |>
  group_by(piece, game_id) |>
  summarize(uses = n()) |>
  arrange(game_id) |>
  ggplot(aes(x=reorder(piece, -uses, median), y=uses)) +
    geom_boxplot(outlier.shape = NA) +
    ggtitle("Number of times each type of piece was used per game") +
    ylim(0, 60) +
    labs(y="Uses", x="Piece")
```
It is unsurprising that pawns are moved more than any other piece in any given game. Each player starts with eight pawns on the board compared to two knights, bishops and rooks, along with one king and one queen. Additionally, the pawns form a wall at the beginning of the game that no piece besides the knight can pass. In general, moving a king a lot before the end game is seen as unfavorable. This is because the king can only move one square at a time (except when castling), and thus, greater positional and tactical advantages can be gained by moving another piece. Additionally, moving the king before the end game suggests the king might be in danger. This is something that players want to avoid.

Everything changes in the end game, where most pieces are removed from the board, and the king isn't in any immediate danger. In most endgames, both players are trying to advance a pawn to furthest rank on the opponent's side of the board in order to make the pawn into a queen. Because of the limited movement of pawns, only being able to move forward and capture diagonally, the king, who can move in any direction, becomes a valuable asset for stopping these pawns. In many cases, it is clear what the result of an endgame will be and the players do not feel the need to play it out. This could be one reason that the box does not extend higher for the king; however, when players do decide to play out end games, this can result in many king moves, which is one reason that the kings could have a higher maximum number of moves than queens.

Because there are more knights, bishops and rooks than kings and queens, it also isn't terribly surprising that they average more moves per game than the royalty they serve.